@page "/login/{returnurl?}"

@inject IJSRuntime jsRuntime
@inject NavigationManager navigation
@inject IAuthenticationService authenticationService

<PageTitle>Login</PageTitle>

<EditForm Model="loginInfo" OnValidSubmit="LoginCallback">
    <DataAnnotationsValidator />

    <p>
        <label for="email">Email </label>
        <InputText id="email" @bind-Value="loginInfo.Email" autocomplete="0"/>
        <ValidationMessage For="() => loginInfo.Email" />
    </p>

    <p>
        <label for="password">Password </label>
        <InputText id="password" type="password" @bind-Value="loginInfo.Password" />
        <ValidationMessage For="() => loginInfo.Password" />
    </p>

    <button type="submit" disabled="@loading">
        @if (loading)
        {
            <span class="spinner-border spinner-border-sm"></span>
        }
        로그인
    </button>
</EditForm>

@code {
    [Parameter]
    public string? ReturnUrl { get; set; }

    [CascadingParameter]
    protected Task<AuthenticationState> AuthState { get; set; }

    private LoginInfo loginInfo = new();
    private bool loading = false;

    private async void LoginCallback()
    {
        loading = true;
        EErrorCode errorCode = await authenticationService.LoginAsync(loginInfo);

        switch (errorCode)
        {
            case EErrorCode.NoError:
                {
                    navigation.NavigateTo(ReturnUrl ?? "/", true);
                    return;
                }
            case EErrorCode.EmailNotExist:
            case EErrorCode.WrongPassword:
                {
                    await jsRuntime.InvokeVoidAsync("Alert", "이메일 혹은 비밀번호가 일치하지 않습니다");
                    loginInfo.Password = "";
                    loading = false;
                    StateHasChanged();
                    break;
                }
            case EErrorCode.EmailNotVerified:
                {
                    await jsRuntime.InvokeVoidAsync("Alert", "이메일 인증 후 사용 가능합니다");
                    break;
                }
            default:
                {
                    Debug.Assert(false);
                    break;
                }
        }
    }

    protected override async void OnInitialized()
    {
        AuthenticationState state = await AuthState;
        if (state.User.Identity?.IsAuthenticated ?? false)
        {
            navigation.NavigateTo(ReturnUrl ?? "/");
        }
    }
}
